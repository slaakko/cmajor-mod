// =================================
// Copyright (c) 2024 Seppo Laakko
// Distributed under the MIT license
// =================================

using System;
using System.Collections;

namespace System.Lex
{
    public class SourceFile
    {
        public SourceFile(ustring&& content_, List<int>&& lineStartIndeces_) : content(content_), lineStartIndeces(lineStartIndeces_)
        {
        }
        public const ustring& Content() const
        {
            return content;
        }
        public const List<int>& LineStartIndeces() const
        {
            return lineStartIndeces;
        }
        public Result<string> GetLine(int lineNumber) const
        {
            int start = lineStartIndeces[lineNumber];
            int len = -1;
            if (lineNumber < lineStartIndeces.Count() - 1)
            {
                len = lineStartIndeces[lineNumber + 1] - start;
            }
            ustring line;
            if (len != -1)
            {
                line = content.Substring(start, len);
            }
            else
            {
                line = content.Substring(start);
            }
            ustring trimmedLine = TrimEnd(line);
            auto result = ToUtf8(trimmedLine);
            if (result.Error())
            {
                return Result<string>(ErrorId(result.GetErrorId()));
            }
            return Result<string>(result.Value());
        }
        private ustring content;
        private List<int> lineStartIndeces;
    }

    public class FileMap
    {
        public int MapFileName(const string& fileName)
        {
            int fileIndex = cast<int>(fileNames.Count());
            fileNames.Add(fileName);
            return fileIndex;
        }
        public bool HasFileName(int fileIndex) const
        {
            return fileIndex >= 0 && fileIndex < fileNames.Count();
        }
        public const List<string>& FileNames() const
        {
            return fileNames;
        }
        public const string& GetFileName(int fileIndex) const
        {
            return fileNames[fileIndex];
        }
        public void AddSourceFile(int fileIndex, ustring&& content, List<int>&& lineStartIndeces)
        {
            sourceFileMap[fileIndex] = SourceFile(content, lineStartIndeces);
        }
        public SourceFile* GetSourceFile(int fileIndex) const
        {
            auto it = sourceFileMap.Find(fileIndex);
            if (it != sourceFileMap.End())
            {
                return &(it->second);
            }
            else
            {
                return null;
            }
        }
        private List<string> fileNames;
        private Map<int, SourceFile> sourceFileMap;
    }

    public Result<string> MakeMessage(const string& message, const Span& span, int fileIndex, FileMap& fileMap)
    {
        string msg = message;
        string fileName;
        if (fileMap.HasFileName(fileIndex))
        {
            fileName = fileMap.GetFileName(fileIndex);
        }
        SourceFile* sourceFile = fileMap.GetSourceFile(fileIndex);
        if (sourceFile != null)
        {
            LineColLen lineColLen = SpanToLineColLen(span, sourceFile->LineStartIndeces());
            System.IO.StringWriter writer;
            auto lineResult = sourceFile->GetLine(lineColLen.line);
            if (lineResult.Error())
            {
                return Result<string>(ErrorId(lineResult.GetErrorId()));
            }
            writer << message << ": " << fileName << ":" << lineColLen.line << ":\n" << lineResult.Value() << "\n" <<
                string(' ', lineColLen.col - 1) << string('^', lineColLen.len) << endl();
            msg = writer.GetString();
        }
        return Result<string>(msg);
    }
}

