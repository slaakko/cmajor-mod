// =================================
// Copyright (c) 2024 Seppo Laakko
// Distributed under the MIT license
// =================================

using System;
using System.Collections;

namespace System.Windows
{
    public class ListViewItemEventArgs
    {
        public ListViewItemEventArgs(ListView* view_, ListViewItem* item_) : view(view_), item(item_), location(), control(false), errorId(0)
        {
        }
        public ListView* view;
        public ListViewItem* item;
        public Point location;
        public bool control;
        public int errorId;
    }

    public class ListViewColumnEventArgs
    {
        public ListViewColumnEventArgs(ListView* view_, ListViewColumn* column_) : view(view_), column(column_)
        {
        }
        public ListView* view;
        public ListViewColumn* column;
    }

    public class delegate void ListViewItemEventHandler(ListViewItemEventArgs& args);
    public class delegate void ListViewColumnEventHandler(ListViewColumnEventArgs& args);

    public Color DefaultListViewBackgroundColor()
    {
        return Color.White();
    }

    public string DefaultListViewFontFamilyName()
    {
        return "Segoe UI";
    }

    public float DefaultListViewFontSize()
    {
        return 9.0f;
    }

    public Color DefaultListViewColumnTextColor()
    {
        return Color(76u, 96u, 122u);
    }

    public Color DefaultListViewItemTextColor()
    {
        return Color.Black();
    }

    public Color DefaultListViewDisabledItemTextColor()
    {
        return Color(201u, 201u, 201u);
    }

    public Color DefaultListViewColumnDividerColor()
    {
        return Color(229u, 229u, 229u);
    }

    public Color DefaultListViewItemSelectedColor()
    {
        return Color(204u, 232u, 255u);
    }

    public Padding DefaultListViewColumnHeaderPadding()
    {
        return Padding(4, 0, 4, 4);
    }

    public Padding DefaultListViewItemPadding()
    {
        return Padding(4, 0, 4, 0);
    }

    public Padding DefaultListViewItemColumnPadding()
    {
        return Padding(4, 0, 4, 0);
    }

    public Padding DefaultListViewColumnDividerPadding()
    {
        return Padding(1, 0, 1, 0);
    }

    public Padding DefaultListViewImagePadding()
    {
        return Padding(2, 2, 2, 2);
    }

    public ControlCreateParams& ListViewControlCreateParams(ControlCreateParams& controlCreateParams)
    {
        return controlCreateParams.SetWindowClassName("System.Windows.ListView").SetWindowClassStyle(DoubleClickWindowClassStyle()).
            SetWindowClassBackgroundColor(SystemColor.COLOR_WINDOW).SetBackgroundColor(DefaultListViewBackgroundColor());
    }

    public class ListViewCreateParams
    {
        public ListViewCreateParams(ControlCreateParams& controlCreateParams_) :
            controlCreateParams(controlCreateParams_),
            allowMultiselect(false),
            fontFamilyName(DefaultListViewFontFamilyName()),
            fontSize(DefaultListViewFontSize()),
            columnTextColor(DefaultListViewColumnTextColor()),
            itemTextColor(DefaultListViewItemTextColor()),
            disabledItemTextColor(DefaultListViewDisabledItemTextColor()),
            columnDividerColor(DefaultListViewColumnDividerColor()),
            itemSelectedColor(DefaultListViewItemSelectedColor()),
            columnHeaderPadding(DefaultListViewColumnHeaderPadding()),
            itemPadding(DefaultListViewItemPadding()),
            itemColumnPadding(DefaultListViewItemColumnPadding()),
            columnDividerPadding(DefaultListViewColumnDividerPadding()),
            imagePadding(DefaultListViewImagePadding())
        {
        }
        public ListViewCreateParams& Defaults()
        {
            return *this;
        }
        public ListViewCreateParams& SetAllowMultiselect(bool allowMultiselect_)
        {
            allowMultiselect = allowMultiselect_;
            return *this;
        }
        public ListViewCreateParams& SetFontFamilyName(const string& fontFamilyName_)
        {
            fontFamilyName = fontFamilyName_;
            return *this;
        }
        public ListViewCreateParams& SetFontSize(float fontSize_)
        {
            fontSize = fontSize_;
            return *this;
        }
        public ListViewCreateParams& SetColumnTextColor(const Color& columnTextColor_)
        {
            columnTextColor = columnTextColor_;
            return *this;
        }
        public ListViewCreateParams& SetItemTextColor(const Color& itemTextColor_)
        {
            itemTextColor = itemTextColor_;
            return *this;
        }
        public ListViewCreateParams& SetDisabledItemTextColor(const Color& disabledItemTextColor_)
        {
            disabledItemTextColor = disabledItemTextColor_;
            return *this;
        }
        public ListViewCreateParams& SetColumnDividerColor(const Color& columnDividerColor_)
        {
            columnDividerColor = columnDividerColor_;
            return *this;
        }
        public ListViewCreateParams& SetItemSelectedColor(const Color& itemSelectedColor_)
        {
            itemSelectedColor = itemSelectedColor_;
            return *this;
        }
        public ListViewCreateParams& SetColumnHeaderPadding(const Padding& columnHeaderPadding_)
        {
            columnHeaderPadding = columnHeaderPadding_;
            return *this;
        }
        public ListViewCreateParams& SetItemPadding(const Padding& itemPadding_)
        {
            itemPadding = itemPadding_;
            return *this;
        }
        public ListViewCreateParams& SetItemColumnPadding(const Padding& itemColumnPadding_)
        {
            itemColumnPadding = itemColumnPadding_;
            return *this;
        }
        public ListViewCreateParams& SetColumnDividerPadding(const Padding& columnDividerPadding_)
        {
            columnDividerPadding = columnDividerPadding_;
            return *this;
        }
        public ListViewCreateParams& SetImagePadding(const Padding& imagePadding_)
        {
            imagePadding = imagePadding_;
            return *this;
        }
        public ControlCreateParams& controlCreateParams;
        public bool allowMultiselect;
        public string fontFamilyName;
        public float fontSize;
        public Color columnTextColor;
        public Color itemTextColor;
        public Color disabledItemTextColor;
        public Color columnDividerColor;
        public Color itemSelectedColor;
        public Padding columnHeaderPadding;
        public Padding itemPadding;
        public Padding itemColumnPadding;
        public Padding columnDividerPadding;
        public Padding imagePadding;
    }

    public class ListView : Control
    {
        public enum Flags : int
        {
            none = 0, measured = 1 << 0, allowMultiselect = 1 << 1
        }
        public ListView(ListViewCreateParams& createParams) :
            base(createParams.controlCreateParams),
            flags(Flags.none), imageList(null),
            columnHeaderTextBrush(createParams.columnTextColor),
            itemTextBrush(createParams.itemTextColor),
            disabledItemTextBrush(createParams.disabledItemTextColor),
            itemSelectedBrush(createParams.itemSelectedColor),
            columnDividerPen(createParams.columnDividerColor),
            stringFormat(),
            columnHeaderPadding(createParams.columnHeaderPadding),
            itemPadding(createParams.itemPadding),
            itemColumnPadding(createParams.itemColumnPadding),
            columnDividerPadding(createParams.columnDividerPadding),
            imagePadding(createParams.imagePadding),
            charWidth(0),
            charHeight(0),
            columnDividerWidth(1),
            ellipsisWidth(0),
            mouseDownItem(null),
            mouseEnterItem(null),
            selectedItem(null),
            mouseDownColumnDivider(null),
            data(null),
            arrowCursor(),
            columnSizeCursor(null)
        {
            auto cursorResult = LoadStandardCursor(StandardCursorId.IDC_ARROW);
            if (cursorResult.Error())
            {
                SetErrorId(cursorResult.GetErrorId());
                return;
            }
            arrowCursor = Rvalue(cursorResult.Value());
            auto columnSizeCursorResult = Application.GetResourceManager().GetCursor("column.size.system.windows.cursor");
            if (columnSizeCursorResult.Error())
            {
                SetErrorId(columnSizeCursorResult.GetErrorId());
                return;
            }
            columnSizeCursor = Rvalue(columnSizeCursorResult.Value());
            if (createParams.allowMultiselect)
            {
                SetFlag(Flags.allowMultiselect);
            }
            SetFont(Font(FontFamily(createParams.fontFamilyName), createParams.fontSize));
        }
        public inline ImageList* GetImageList() const
        {
            return imageList;
        }
        public void SetImageList(ImageList* imageList_)
        {
            imageList = imageList_;
        }
        public const StringFormat& GetStringFormat() const
        {
            return stringFormat;
        }
        public const Brush& ColumnHeaderTextBrush() const
        {
            return columnHeaderTextBrush;
        }
        public const Brush* ItemTextBrush() const
        {
            return &itemTextBrush;
        }
        public const Brush* DisabledItemTextBrush() const
        {
            return &disabledItemTextBrush;
        }
        public const Brush& ItemSelectedBrush() const
        {
            return itemSelectedBrush;
        }
        public const Pen& ColumnDividerPen() const
        {
            return columnDividerPen;
        }
        public const Padding& ColumnHeaderPadding() const
        {
            return columnHeaderPadding;
        }
        public const Padding& ItemPadding() const
        {
            return itemPadding;
        }
        public const Padding& ItemColumnPadding() const
        {
            return itemColumnPadding;
        }
        public const Padding& ColumnDividerPadding() const
        {
            return columnDividerPadding;
        }
        public const Padding& ImagePadding() const
        {
            return imagePadding;
        }
        public inline bool GetFlag(Flags flag) const
        {
            return (flags & flag) != Flags.none;
        }
        public void SetFlag(Flags flag)
        {
            flags = cast<Flags>(flags | flag);
        }
        public void ResetFlag(Flags flag)
        {
            flags = cast<Flags>(flags & ~flag);
        }
        public int ColumnCount() const
        {
            return cast<int>(columns.Count());
        }
        public void AddColumn(const string& name, int width)
        {
            ListViewColumn* column = new ListViewColumn(this, name, width);
            columns.Add(UniquePtr<ListViewColumn>(column));
            columnDividers.Add(UniquePtr<ListViewColumnDivider>(new ListViewColumnDivider(this, column)));
        }
        [nodiscard]
        public Result<ListViewColumn*> GetColumn(int columnIndex) const
        {
            if (columnIndex < 0 || columnIndex >= ColumnCount())
            {
                int errorId = AllocateError("invalid column index");
                return Result<ListViewColumn*>(ErrorId(errorId));
            }
            return Result<ListViewColumn*>(columns[columnIndex].Get());
        }
        public int ItemCount() const
        {
            return cast<int>(items.Count());
        }
        public ListViewItem* AddItem()
        {
            ListViewItem* item = new ListViewItem(this);
            items.Add(UniquePtr<ListViewItem>(item));
            return item;
        }
        [nodiscard]
        public Result<ListViewItem*> GetItem(int itemIndex) const
        {
            if (itemIndex < 0 || itemIndex >= ItemCount())
            {
                int errorId = AllocateError("invalid item index");
                return Result<ListViewItem*>(ErrorId(errorId));
            }
            return Result<ListViewItem*>(items[itemIndex].Get());
        }
        public inline ListViewItem* SelectedItem() const
        {
            return selectedItem;
        }
        [nodiscard]
        public Result<bool> SetSelectedItem(ListViewItem* selectedItem_)
        {
            if (GetFlag(Flags.allowMultiselect))
            {
                auto result = ResetSelectedItems();
                if (result.Error()) return result;
            }
            if (selectedItem != selectedItem_)
            {
                if (selectedItem != null)
                {
                    auto result = selectedItem->ResetSelected();
                    if (result.Error()) return result;
                }
                selectedItem = selectedItem_;
                if (selectedItem != null)
                {
                    auto result = selectedItem->SetSelected();
                    if (result.Error()) return result;
                }
            }
            return Result<bool>(true);
        }
        public List<ListViewItem*> GetSelectedItems() const
        {
            List<ListViewItem*> result;
            for (const UniquePtr<ListViewItem>& item : items)
            {
                if (item->IsSelected())
                {
                    result.Add(item.Get());
                }
            }
            return result;
        }
        [nodiscard]
        public Result<bool> ResetSelectedItems()
        {
            for (const UniquePtr<ListViewItem>& item : items)
            {
                if (item.Get() != SelectedItem())
                {
                    if (item->IsSelected())
                    {
                        auto result = item->ResetSelected();
                        if (result.Error()) return result;
                    }
                }
            }
            return Result<bool>(true);
        }
        public ListViewItem* ItemAt(const Point& location) const
        {
            for (const UniquePtr<ListViewItem>& item : items)
            {
                Rect rect(item->Location(), item->GetSize());
                if (rect.Contains(location))
                {
                    return item.Get();
                }
            }
            return null;
        }
        public ListViewColumnDivider* ColumnDividerAt(const Point& location) const
        {
            for (const UniquePtr<ListViewColumnDivider>& columnDivider : columnDividers)
            {
                Rect rect(columnDivider->Location(), columnDivider->GetSize());
                if (rect.Contains(location))
                {
                    return columnDivider.Get();
                }
            }
            return null;
        }
        public inline float TextHeight() const
        {
            return charHeight;
        }
        public inline float ColumnDividerWidth() const
        {
            return columnDividerWidth;
        }
        public float EllipsisWidth() const
        {
            return ellipsisWidth;
        }
        public void FireColumnWidthChanged(ListViewColumn* column)
        {
            ListViewColumnEventArgs args(this, column);
            OnColumnWidthChanged(args);
        }
        public void SetData(void* data_)
        {
            data = data_;
        }
        public inline void* Data() const
        {
            return data;
        }
        public Event<ListViewItemEventHandler, ListViewItemEventArgs>& ItemClickEvent()
        {
            return itemClickEvent;
        }
        public Event<ListViewItemEventHandler, ListViewItemEventArgs>& ItemRightClickEvent()
        {
            return itemRightClickEvent;
        }
        public Event<ListViewItemEventHandler, ListViewItemEventArgs>& ItemDoubleClickEvent()
        {
            return itemDoubleClickEvent;
        }
        public Event<ListViewItemEventHandler, ListViewItemEventArgs>& ItemEnterEvent()
        {
            return itemEnterEvent;
        }
        public Event<ListViewItemEventHandler, ListViewItemEventArgs>& ItemLeaveEvent()
        {
            return itemLeaveEvent;
        }
        public Event<ListViewColumnEventHandler, ListViewColumnEventArgs>& ColumnWidthChangedEvent()
        {
            return columnWidthChangedEvent;
        }
        [nodiscard]
        protected override Result<bool> OnSizeChanged(SizeChangedEventArgs& args)
        {
            auto result = base->OnSizeChanged(args);
            if (result.Error()) return result;
            SetContentLocation(Point(0, 0));
            return Result<bool>(true);
        }
        [nodiscard]
        protected override Result<bool> OnPaint(PaintEventArgs& args)
        {
            if (!GetFlag(Flags.measured))
            {
                SetFlag(Flags.measured);
                auto result = Measure(args.graphics);
                if (result.Error())
                {
                    return Result<bool>(ErrorId(result.GetErrorId()));
                }
            }
            Size contentSize(0, 0);
            auto result = args.graphics.Clear(BackgroundColor());
            if (result.Error()) return result;
            PointF origin;
            auto measureResult = MeasureItems(args.graphics, contentSize);
            if (measureResult.Error())
            {
                return Result<bool>(ErrorId(measureResult.GetErrorId()));
            }
            result = DrawColumnHeader(args.graphics, origin);
            if (result.Error()) return result;
            result = DrawItems(args.graphics, origin);
            if (result.Error()) return result;
            result = SetContentSize(contentSize);
            if (result.Error()) return result;
            return base->OnPaint(args);
        }
        [nodiscard]
        protected override Result<bool> OnMouseDown(MouseEventArgs& args)
        {
            mouseDownItem = null;
            ListViewItem* item = ItemAt(args.location);
            if (item != null)
            {
                mouseDownItem = item;
            }
            else
            {
                auto result = SetSelectedItem(null);
                if (result.Error()) return result;
            }
            if (args.buttons == MouseButtons.lbutton)
            {
                ListViewColumnDivider* columnDivider = ColumnDividerAt(args.location);
                if (columnDivider != null)
                {
                    columnDivider->OnLButtonDown(args.location);
                    mouseDownColumnDivider = columnDivider;
                }
            }
            return Result<bool>(true);
        }
        [nodiscard]
        protected override Result<bool> OnMouseUp(MouseEventArgs& args)
        {
            ListViewItem* item = ItemAt(args.location);
            if (item == mouseDownItem)
            {
                ListViewItemEventArgs itemArgs(this, item);
                if ((args.buttons & MouseButtons.lbutton) != MouseButtons.none)
                {
                    if (GetFlag(Flags.allowMultiselect))
                    {
                        if ((args.buttons & MouseButtons.control) != MouseButtons.none)
                        {
                            itemArgs.control = true;
                        }
                    }
                    itemClickEvent.Fire(itemArgs);
                }
                else if (args.buttons == MouseButtons.rbutton)
                {
                    itemArgs.location = args.location;
                    itemRightClickEvent.Fire(itemArgs);
                }
                if (itemArgs.errorId != 0)
                {
                    return Result<bool>(ErrorId(itemArgs.errorId));
                }
            }
            mouseDownItem = null;
            if (args.buttons == MouseButtons.lbutton)
            {
                if (mouseDownColumnDivider != null)
                {
                    mouseDownColumnDivider->OnLButtonUp();
                    mouseDownColumnDivider = null;
                }
            }
            return Result<bool>(true);
        }
        [nodiscard]
        protected override Result<bool> OnMouseDoubleClick(MouseEventArgs& args)
        {
            ListViewItem* item = ItemAt(args.location);
            if (item != null)
            {
                ListViewItemEventArgs args(this, item);
                itemDoubleClickEvent.Fire(args);
            }
            mouseDownItem = null;
            return Result<bool>(true);
        }
        [nodiscard]
        protected override Result<bool> OnMouseEnter()
        {
            mouseEnterItem = null;
            return Result<bool>(true);
        }
        protected override Result<bool> OnMouseLeave()
        {
            if (mouseEnterItem != null)
            {
                ListViewItemEventArgs leaveItemArgs(this, mouseEnterItem);
                itemLeaveEvent.Fire(leaveItemArgs);
                mouseEnterItem = null;
            }
            return Result<bool>(true);
        }
        [nodiscard]
        protected override Result<bool> OnMouseMove(MouseEventArgs& args)
        {
            if (mouseEnterItem == null)
            {
                mouseEnterItem = ItemAt(args.location);
                if (mouseEnterItem != null)
                {
                    ListViewItemEventArgs itemArgs(this, mouseEnterItem);
                    itemEnterEvent.Fire(itemArgs);
                }
            }
            else
            {
                ListViewItem* item = ItemAt(args.location);
                if (item != mouseEnterItem)
                {
                    ListViewItemEventArgs leaveItemArgs(this, mouseEnterItem);
                    itemLeaveEvent.Fire(leaveItemArgs);
                    mouseEnterItem = item;
                    if (mouseEnterItem != null)
                    {
                        ListViewItemEventArgs enterItemArgs(this, mouseEnterItem);
                        itemEnterEvent.Fire(enterItemArgs);
                    }
                }
            }
            if (args.buttons == MouseButtons.lbutton)
            {
                if (mouseDownColumnDivider != null)
                {
                    if (mouseDownColumnDivider->HasMouseCapture())
                    {
                        auto result = mouseDownColumnDivider->OnMouseMove(args.location);
                        if (result.Error()) return result;
                    }
                }
            }
            return Result<bool>(true);
        }
        protected virtual void OnColumnWidthChanged(ListViewColumnEventArgs& args)
        {
            columnWidthChangedEvent.Fire(args);
        }
        protected override Result<bool> SetCursor()
        {
            Point pt;
            auto cpResult = GetCursorPos(pt.x, pt.y);
            if (cpResult.Error()) return cpResult;
            auto result = ScreenToClient(pt);
            if (result.Error())
            {
                return Result<bool>(ErrorId(result.GetErrorId()));
            }
            Point cursorPos = result.Value();
            bool cursorSet = false;
            for (const UniquePtr<ListViewColumnDivider>& columnDivider : columnDividers)
            {
                Rect r(columnDivider->Location(), columnDivider->GetSize());
                if (r.Contains(cursorPos))
                {
                    System.Windows.SetCursor(columnSizeCursor);
                    cursorSet = true;
                    break;
                }
            }
            if (!cursorSet)
            {
                System.Windows.SetCursor(&arrowCursor);
            }
            return Result<bool>(true);
        }
        private Result<bool> Measure(Graphics& graphics)
        {
            auto measureResult = graphics.MeasureStringRectF("This is test string", GetFont(), PointF(0, 0), stringFormat);
            if (measureResult.Error())
            {
                return Result<bool>(ErrorId(measureResult.GetErrorId()));
            }
            RectF charRect = measureResult.Value();
            charHeight = charRect.size.h;
            charWidth = charRect.size.w;
            SetScrollUnits(cast<int>(charHeight + 0.5f), cast<int>(2 * (charWidth + 0.5f)));
            measureResult = graphics.MeasureStringRectF("...", GetFont(), PointF(0, 0), stringFormat);
            if (measureResult.Error())
            {
                return Result<bool>(ErrorId(measureResult.GetErrorId()));
            }
            RectF ellipsisRect = measureResult.Value();
            ellipsisWidth = ellipsisRect.size.w;
            return Result<bool>(true);
        }
        private Result<bool> MeasureItems(Graphics& graphics, Size& contentSize)
        {
            int maxWidth = 0;
            Point loc(itemPadding.left, cast<int>(charHeight + 0.5f + columnHeaderPadding.Vertical()));
            for (const UniquePtr<ListViewItem>& item : items)
            {
                item->SetLocation(loc);
                auto measureResult = item->Measure(graphics);
                if (measureResult.Error())
                {
                    return Result<bool>(ErrorId(measureResult.GetErrorId()));
                }
                Size itemSize = item->GetSize();
                loc.y = loc.y + itemSize.h;
                maxWidth = Max(maxWidth, itemSize.w);
            }
            contentSize.w = Max(contentSize.w, maxWidth);
            contentSize.h = Max(contentSize.h, loc.y);
            return Result<bool>(true);
        }
        private Result<bool> DrawColumnHeader(Graphics& graphics, PointF& origin)
        {
            PointF headerOrigin = origin;
            headerOrigin.x = headerOrigin.x + columnHeaderPadding.left;
            headerOrigin.y = headerOrigin.y + columnHeaderPadding.top;
            long n = columns.Count();
            for (long i = 0; i < n; ++i)
            {
                ListViewColumn* column = columns[i].Get();
                auto drawResult = column->Draw(graphics, headerOrigin);
                if (drawResult.Error())
                {
                    return Result<bool>(ErrorId(drawResult.GetErrorId()));
                }
                headerOrigin.x = headerOrigin.x + column->Width() + columnHeaderPadding.Horizontal();
                ListViewColumnDivider* divider = columnDividers[i].Get();
                headerOrigin.x = headerOrigin.x + columnDividerPadding.left;
                drawResult = divider->Draw(graphics, headerOrigin);
                if (drawResult.Error())
                {
                    return Result<bool>(ErrorId(drawResult.GetErrorId()));
                }
                headerOrigin.x = headerOrigin.x + columnDividerWidth + columnDividerPadding.right;
            }
            origin.y = origin.y + charHeight + columnHeaderPadding.Vertical();
            return Result<bool>(true);
        }
        private Result<bool> DrawItems(Graphics& graphics, PointF& origin)
        {
            for (const UniquePtr<ListViewItem>& item : items)
            {
                PointF itemOrigin = origin;
                itemOrigin.y = itemOrigin.y + itemPadding.top;
                itemOrigin.x = itemOrigin.x + itemPadding.left;
                auto drawResult = item->Draw(graphics, itemOrigin);
                if (drawResult.Error())
                {
                    return Result<bool>(ErrorId(drawResult.GetErrorId()));
                }
                Size sz = item->GetSize();
                origin.y = origin.y + sz.h;
            }
            return Result<bool>(true);
        }
        private Flags flags;
        private ImageList* imageList;
        private SolidBrush columnHeaderTextBrush;
        private SolidBrush itemTextBrush;
        private SolidBrush disabledItemTextBrush;
        private SolidBrush itemSelectedBrush;
        private Pen columnDividerPen;
        private StringFormat stringFormat;
        private Padding columnHeaderPadding;
        private Padding itemPadding;
        private Padding itemColumnPadding;
        private Padding columnDividerPadding;
        private Padding imagePadding;
        private float charWidth;
        private float charHeight;
        private float columnDividerWidth;
        private float ellipsisWidth;
        private ListViewItem* mouseDownItem;
        private ListViewItem* mouseEnterItem;
        private ListViewItem* selectedItem;
        private ListViewColumnDivider* mouseDownColumnDivider;
        private void* data;
        private Cursor arrowCursor;
        private Cursor* columnSizeCursor;
        private List<UniquePtr<ListViewColumn>> columns;
        private List<UniquePtr<ListViewColumnDivider>> columnDividers;
        private List<UniquePtr<ListViewItem>> items;
        private Event<ListViewItemEventHandler, ListViewItemEventArgs> itemClickEvent;
        private Event<ListViewItemEventHandler, ListViewItemEventArgs> itemRightClickEvent;
        private Event<ListViewItemEventHandler, ListViewItemEventArgs> itemDoubleClickEvent;
        private Event<ListViewItemEventHandler, ListViewItemEventArgs> itemEnterEvent;
        private Event<ListViewItemEventHandler, ListViewItemEventArgs> itemLeaveEvent;
        private Event<ListViewColumnEventHandler, ListViewColumnEventArgs> columnWidthChangedEvent;
    }

    public class ListViewColumn
    {
        public ListViewColumn(ListView* view_, const string& name_, int width_) :
            view(view_), name(name_), width(width_), minWidth(0)
        {
        }
        public inline const string& Name() const
        {
            return name;
        }
        public inline int Width() const
        {
            return width;
        }
        [nodiscard]
        public Result<bool> SetWidth(int width_)
        {
            if (width != width_)
            {
                width = width_;
                view->FireColumnWidthChanged(this);
                auto result = view->Invalidate();
                if (result.Error()) return result;
            }
            return Result<bool>(true);
        }
        public inline int MinWidth() const
        {
            return minWidth;
        }
        public void SetMinWidth(int minWidth_)
        {
            minWidth = minWidth_;
        }
        [nodiscard]
        public Result<bool> Draw(Graphics& graphics, const PointF& origin)
        {
            auto drawResult = graphics.DrawString(name, view->GetFont(), origin, view->ColumnHeaderTextBrush());
            return drawResult;
        }
        private ListView* view;
        private string name;
        private int width;
        private int minWidth;
    }

    public class ListViewColumnDivider
    {
        public ListViewColumnDivider(ListView* view_, ListViewColumn* column_) :
            view(view_), column(column_), location(), startCapturePos(), startColumnWidth(0), hasMouseCapture(false)
        {
        }
        public inline const Point& Location() const
        {
            return location;
        }
        public Size GetSize() const
        {
            return Size(cast<int>(view->ColumnDividerWidth() + 4 * view->ColumnDividerPadding().Horizontal() + 0.5f), cast<int>(view->TextHeight() + 0.5f));
        }
        public inline bool HasMouseCapture() const
        {
            return hasMouseCapture;
        }
        public void OnLButtonDown(const Point& pos)
        {
            WinSetCapture(view->Handle());
            startCapturePos = pos;
            startColumnWidth = column->Width();
            hasMouseCapture = true;
        }
        [nodiscard]
        public Result<bool> OnMouseMove(const Point& pos)
        {
            auto result = column->SetWidth(Max(column->MinWidth(), startColumnWidth + pos.x - startCapturePos.x));
            if (result.Error()) return result;
            return Result<bool>(true);
        }
        public void OnLButtonUp()
        {
            WinReleaseCapture();
            hasMouseCapture = false;
        }
        [nodiscard]
        public Result<bool> Draw(Graphics& graphics, const PointF& origin)
        {
            const Pen& pen = view->ColumnDividerPen();
            Size sz = GetSize();
            location = Point(cast<int>(origin.x - sz.w / 2), cast<int>(origin.y));
            PointF end = origin;
            end.y = end.y + view->TextHeight();
            auto drawResult = graphics.DrawLine(pen, origin, end);
            return drawResult;
        }
        private ListView* view;
        private ListViewColumn* column;
        private Point location;
        private Point startCapturePos;
        private int startColumnWidth;
        private bool hasMouseCapture;
    }

    public class ListViewItem
    {
        public enum Flags : int
        {
            none = 0, disabled = 1 << 0, selected = 1 << 1
        }
        public enum State : int
        {
            enabled, disabled
        }
        public ListViewItem(ListView* view_) : view(view_), flags(Flags.none), imageIndex(-1), disabledImageIndex(-1), data(null)
        {
        }
        [nodiscard]
        public Result<bool> SetColumnValue(int columnIndex, const string& columnValue)
        {
            if (columnIndex < 0)
            {
                int errorId = AllocateError("invalid column index");
                return Result<bool>(ErrorId(errorId));
            }
            while (columnIndex >= columnValues.Count())
            {
                columnValues.Add(string());
            }
            columnValues[columnIndex] = columnValue;
            return Result<bool>(true);
        }
        [nodiscard]
        public Result<string> GetColumnValue(int columnIndex) const
        {
            if (columnIndex < 0)
            {
                int errorId = AllocateError("invalid column index");
                return Result<string>(ErrorId(errorId));
            }
            if (columnIndex >= columnValues.Count())
            {
                return string();
            }
            return Result<string>(columnValues[columnIndex]);
        }
        [nodiscard]
        public Result<bool> Draw(Graphics& graphics, PointF& origin)
        {
            if (IsSelected())
            {
                const Brush& selectedBrush = view->ItemSelectedBrush();
                Rect rect(location, size);
                auto result = graphics.FillRectangle(selectedBrush, rect);
                if (result.Error())
                {
                    return Result<bool>(ErrorId(result.GetErrorId()));
                }
            }
            PointF itemOrigin = origin;
            int imageSpace = 0;
            auto result = DrawImage(graphics, itemOrigin, imageSpace);
            if (result.Error())
            {
                return Result<bool>(ErrorId(result.GetErrorId()));
            }
            for (int index = 0; index < view->ColumnCount(); ++index)
            {
                int imgSpc = 0;
                if (index == 0)
                {
                    imgSpc = imageSpace;
                }
                imgSpc = imageSpace;
                bool clipped = false;
                Region prevClip;
                if (index < textWidths.Count())
                {
                    auto getColumnResult = view->GetColumn(index);
                    if (getColumnResult.Error())
                    {
                        return Result<bool>(ErrorId(getColumnResult.GetErrorId()));
                    }
                    ListViewColumn* column = getColumnResult.Value();
                    if (textWidths[index] > column->Width())
                    {
                        auto clipResult = graphics.GetClip();
                        if (clipResult.Error())
                        {
                            return Result<bool>(ErrorId(clipResult.GetErrorId()));
                        }
                        prevClip = clipResult.Value();
                        clipped = true;
                        auto columnResult = view->GetColumn(index);
                        if (columnResult.Error())
                        {
                            return Result<bool>(ErrorId(columnResult.GetErrorId()));
                        }
                        ListViewColumn* column = columnResult.Value();
                        Size itemSize(Size(cast<int>(column->Width() - view->EllipsisWidth() - imgSpc), cast<int>(view->TextHeight())));
                        Rect clip(Point(cast<int>(itemOrigin.x), cast<int>(itemOrigin.y)), itemSize);
                        auto setClipResult = graphics.SetClip(clip);
                        if (setClipResult.Error())
                        {
                            return Result<bool>(ErrorId(setClipResult.GetErrorId()));
                        }
                    }
                }
                const Brush* brush = view->ItemTextBrush();
                if (GetState() == State.disabled)
                {
                    brush = view->DisabledItemTextBrush();
                }
                auto columnValueResult = GetColumnValue(index);
                if (columnValueResult.Error())
                {
                    return Result<bool>(ErrorId(columnValueResult.GetErrorId()));
                }
                string columnValue = Rvalue(columnValueResult.Value());
                auto result = graphics.DrawString(columnValue, view->GetFont(), itemOrigin, *brush);
                if (result.Error())
                {
                    return Result<bool>(ErrorId(result.GetErrorId()));
                }
                auto columnResult = view->GetColumn(index);
                if (columnResult.Error())
                {
                    return Result<bool>(ErrorId(columnResult.GetErrorId()));
                }
                ListViewColumn* column = columnResult.Value();
                itemOrigin.x = itemOrigin.x + column->Width();
                if (clipped)
                {
                    auto setClipResult = graphics.SetClip(prevClip);
                    if (setClipResult.Error())
                    {
                        return Result<bool>(ErrorId(setClipResult.GetErrorId()));
                    }
                    PointF ellipsisOrigin(itemOrigin.x - view->EllipsisWidth() - imgSpc, itemOrigin.y);
                    auto result = graphics.DrawString("...", view->GetFont(), ellipsisOrigin, *brush);
                    if (result.Error())
                    {
                        return Result<bool>(ErrorId(result.GetErrorId()));
                    }
                }
                itemOrigin.x = itemOrigin.x + view->ColumnDividerPadding().Horizontal() + view->ColumnDividerWidth() - imgSpc;
                itemOrigin.x = itemOrigin.x + view->ItemColumnPadding().Horizontal();
            }
            return Result<bool>(true);
        }
        [nodiscard]
        public Result<bool> Measure(Graphics& graphics)
        {
            float width = 0;
            float height = 0;
            Bitmap* image = null;
            ImageList* imageList = view->GetImageList();
            if (imageList != null)
            {
                if (GetState() == State.enabled)
                {
                    image = imageList->GetImage(imageIndex);
                }
                else
                {
                    image = imageList->GetImage(disabledImageIndex);
                }
            }
            if (image != null)
            {
                int imageWidth = cast<int>(image->GetWidth());
                int imageHeight = cast<int>(image->GetHeight());
                Padding padding = view->ImagePadding();
                if (view->ColumnCount() > 0)
                {
                    auto columnResult = view->GetColumn(0);
                    if (columnResult.Error())
                    {
                        return Result<bool>(ErrorId(columnResult.GetErrorId()));
                    }
                    ListViewColumn* firstColumn = columnResult.Value();
                    firstColumn->SetMinWidth(Max(firstColumn->MinWidth(), cast<int>(imageWidth + padding.Horizontal() + view->EllipsisWidth() + 0.5f)));
                }
                height = imageHeight + padding.Vertical();
            }
            for (int index = 0; index < view->ColumnCount(); ++index)
            {
                auto columnResult = view->GetColumn(index);
                if (columnResult.Error())
                {
                    return Result<bool>(ErrorId(columnResult.GetErrorId()));
                }
                ListViewColumn* column = columnResult.Value();
                width = width + column->Width();
                width = width + view->ColumnDividerWidth() + view->ColumnDividerPadding().Horizontal();
                height = Max(height, view->TextHeight());
                column->SetMinWidth(Max(column->MinWidth(), cast<int>(view->EllipsisWidth() + 0.5f)));
            }
            width = width + view->ItemPadding().Horizontal();
            size = Size(cast<int>(width + 0.5f), cast<int>(height + 0.5f));
            textWidths.Clear();
            for (const string& columnValue : columnValues)
            {
                auto measureResult = graphics.MeasureStringRectF(columnValue, view->GetFont(), PointF(0, 0), view->GetStringFormat());
                if (measureResult.Error())
                {
                    return Result<bool>(ErrorId(measureResult.GetErrorId()));
                }
                RectF r = measureResult.Value();
                textWidths.Add(r.size.w);
            }
            return Result<bool>(true);
        }
        public inline const Point& Location() const
        {
            return location;
        }
        public void SetLocation(const Point& location_)
        {
            location = location_;
        }
        public inline const Size& GetSize() const
        {
            return size;
        }
        public inline bool GetFlag(Flags flag) const
        {
            return (flags & flag) != Flags.none;
        }
        public inline void SetFlag(Flags flag)
        {
            flags = cast<Flags>(flags | flag);
        }
        public inline void ResetFlag(Flags flag)
        {
            flags = cast<Flags>(flags & ~flag);
        }
        public inline bool IsSelected() const
        {
            return GetFlag(Flags.selected);
        }
        [nodiscard]
        public Result<bool> SetSelected()
        {
            if (!IsSelected())
            {
                SetFlag(Flags.selected);
                auto result = view->Invalidate();
                if (result.Error()) return result;
            }
            return Result<bool>(true);
        }
        [nodiscard]
        public Result<bool> ResetSelected()
        {
            if (IsSelected())
            {
                ResetFlag(Flags.selected);
                auto result = view->Invalidate();
                if (result.Error()) return result;
            }
            return Result<bool>(true);
        }
        public State GetState() const
        {
            if (GetFlag(Flags.disabled))
            {
                return State.disabled;
            }
            else
            {
                return State.enabled;
            }
        }
        [nodiscard]
        public Result<bool> SetState(State state)
        {
            if (state != GetState())
            {
                if (state == State.disabled)
                {
                    SetFlag(Flags.disabled);
                }
                else
                {
                    ResetFlag(Flags.disabled);
                }
                auto result = view->Invalidate();
                if (result.Error()) return result;
            }
            return Result<bool>(true);
        }
        public inline ListView* View() const
        {
            return view;
        }
        public inline void* Data() const
        {
            return data;
        }
        public void SetData(void* data_)
        {
            data = data_;
        }
        public inline int ImageIndex() const
        {
            return imageIndex;
        }
        public void SetImageIndex(int imageIndex_)
        {
            imageIndex = imageIndex_;
        }
        public inline int DisabledImageIndex() const
        {
            return disabledImageIndex;
        }
        public void SetDisabledImageIndex(int disabledImageIndex_)
        {
            disabledImageIndex = disabledImageIndex_;
        }
        private Result<bool> DrawImage(Graphics& graphics, PointF& origin, int& imageSpace)
        {
            imageSpace = 0;
            Bitmap* image = null;
            ImageList* imageList = view->GetImageList();
            if (imageList != null)
            {
                if (GetState() == State.enabled)
                {
                    image = imageList->GetImage(imageIndex);
                }
                else
                {
                    image = imageList->GetImage(disabledImageIndex);
                }
            }
            if (image != null)
            {
                int imageWidth = cast<int>(image->GetWidth());
                int imageHeight = cast<int>(image->GetHeight());
                Padding padding = view->ImagePadding();
                Point imageLoc = Point(cast<int>(origin.x), cast<int>(origin.y));
                imageLoc.x = imageLoc.x + padding.left;
                imageLoc.y = imageLoc.y + padding.top;
                Rect r(imageLoc, Size(imageWidth + padding.Horizontal(), imageHeight + padding.Vertical()));
                ImageAttributes attributes;
                if (attributes.Error())
                {
                    return Result<bool>(ErrorId(attributes.GetErrorId()));
                }
                auto setResult = attributes.SetColorKey(Color.DefaultBitmapTransparent(), Color.DefaultBitmapTransparent(), ColorAdjustType.default_);
                if (setResult.Error())
                {
                    return Result<bool>(ErrorId(setResult.GetErrorId()));
                }
                auto drawResult = graphics.DrawImage(*image, r, 0, 0, imageWidth + padding.Horizontal(), imageHeight + padding.Vertical(), Unit.pixel, attributes);
                if (drawResult.Error())
                {
                    return Result<bool>(ErrorId(drawResult.GetErrorId()));
                }
                imageSpace = imageWidth + padding.Horizontal();
                origin.x = origin.x + imageSpace;
            }
            return Result<bool>(true);
        }
        private Flags flags;
        private Point location;
        private Size size;
        private ListView* view;
        private int imageIndex;
        private int disabledImageIndex;
        private void* data;
        private List<string> columnValues;
        private List<float> textWidths;
    }
}
